#+title: Estimated Tree Example

The tool, =ape-sim.R=, (version 0.1.2) can be used to simulate a dataset.

#+begin_src sh
  ./ape-sim.R -v -s 1 -p my-params.json -o out -d 0.15 --simulate-sequences --write-newick --make-plots
#+end_src

The parameters for the simulation are defined in =my-params.json= as shown below.
They correspond to an average infectious period of one week. After infection
there is a \(50\%\) chance the infection will be observed in some manner, and
given that it is observed, there is a \(20\%\) chance it will be sequenced.

#+begin_src json :tangle my-params.json
{
    "birthRate": 104.0,
    "deathRate": 26.0,
    "samplingRate": 5.2,
    "occurrenceRate": 20.8,
    "substitutionRate": 1e-3
}
#+end_src

The file =out/ape-sim-sequences.fasta= contains a simulated set of sequences for
the reconstructed tree. Beauti can use this to generate an XML for the BDSky
model which will work as a starting place for out XML. The result from Beauti
should be saved to a file =out/analysis-bdsky.xml= to make it explicit that this
is using the BDSky prior.

#+begin_src sh
  java -cp <path/to/beast.jar> beast.app.beauti.Beauti
#+end_src

The file =out/ape-sim-event-times.csv= contains the times of all the observations
in the simulation. This needs to be put into the XML along with a list of the
taxa it includes and the occurrence times. The following snippet helps with
formatting the occurrence times for inclusion in the XML.

#+begin_src R
x <- read.csv("out/ape-sim-event-times.csv")
root_length <- x[x$event == "origin", "time"]
occ_times <- sort(x[x$event == "occurrence", "time"] + root_length)
paste(occ_times, collapse = " ")
#+end_src

Which can be run using beast (provided it has access to this package).

#+begin_src sh
  beast estimated-tree-example.xml
#+end_src

The script =posterior-visualisation.R= generates the visualisation of the
posterior samples shown below.

#+attr_org: :width 500
[[./out/posterior-plot.png]]
