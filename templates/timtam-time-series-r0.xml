<beast version='2.0' namespace='beast.app.beauti:beast.core:beast.evolution.branchratemodel:beast.evolution.speciation:beast.evolution.tree.coalescent:beast.core.util:beast.evolution.nuc:beast.evolution.operators:beast.evolution.sitemodel:beast.evolution.substitutionmodel:beast.evolution.likelihood:beast.evolution:beast.math.distributions'>

    <mergewith point='misc' fragment="@TreeOperators"/>

    <mergewith point='treePriorTemplates'>

        <subtemplate id='TimTam Time Series Model' class='timtam.TimTam' mainid='TimTamTimeSeries.t:$(n)'>

            <![CDATA[

            <!-- Prior distribution -->
            <plugin spec='timtam.TimTam' id="TimTamTimeSeries.t:$(n)" tree="@Tree.t:$(n)" parameterisation="timeSeriesR0">
                <parameter name='r0' id='TTTSR0.t:$(n)' value='1.850' estimate='true' lower='0.0'/>
                <parameter name='sigma' id='TTTSNetRemovalRate.t:$(n)' value='0.100' estimate='false' lower='0.0'/>
                <parameter name='propPsi' id='TTTSPropPsi.t:$(n)' value='0.100' estimate='true' lower='0.0' upper='1.0'/>
                <parameter name='propTimeSeries' id='TTTSPropTS.t:$(n)' value='0.400' estimate='true' lower='0.0' upper='1.0'/>
                <parameter name='originTime' id='TTTSOriginTime.t:$(n)' value='100.0' estimate='false'/>
                <parameter name='disasterTimes' id='TTTSDisasterTimes.t:$(n)' value='2.0 1.0 0.0' estimate='false'/>
                <parameter name='disasterSizes' id='TTTSDisasterSizes.t:$(n)' spec='parameter.IntegerParameter' value='1 1 2' estimate='false'/>
                <parameter name='historyTimes' id='TTTSHistoryTimes.t:$(n)' value='0.0' estimate='false'/>
                <parameter name='historySizes' id='TTTSHistorySizes.t:$(n)' spec='parameter.IntegerParameter' value='0' estimate='true'/>
            </plugin>

            <prior
                id="TTTSR0Prior.t:$(n)"
                x="@TTTSR0.t:$(n)">
                <distr spec="beast.math.distributions.Normal">
                    <parameter name="mean" value="2.0" estimate="false"/>
                    <parameter name="sigma" value="2.0" estimate="false"/>
                </distr>
            </prior>

            <prior
                id="TTTSNetRemovalRatePrior.t:$(n)"
                x="@TTTSNetRemovalRate.t:$(n)">
                <distr spec="beast.math.distributions.LogNormalDistributionModel">
                    <parameter name="M" value="-1.0" estimate="false"/>
                    <parameter name="S" value="1.0" estimate="false"/>
                </distr>
            </prior>

            <prior
                id="TTTSPropPsiPrior.t:$(n)"
                x="@TTTSPropPsi.t:$(n)">
                <distr spec="beast.math.distributions.Beta">
                    <parameter name="alpha" value="2.0" estimate="false"/>
                    <parameter name="beta" value="2.0" estimate="false"/>
                </distr>
            </prior>

            <prior
                id="TTTSPropTimeSeriesPrior.t:$(n)"
                x="@TTTSPropTS.t:$(n)">
                <distr spec="beast.math.distributions.Beta">
                    <parameter name="alpha" value="2.0" estimate="false"/>
                    <parameter name="beta" value="2.0" estimate="false"/>
                </distr>
            </prior>

            <prior
                id="TTTSHistorySizesPrior.t:$(n)"
                x="@TTTSHistorySizes.t:$(n)">
                <distr spec="beast.math.distributions.Uniform" lower="0.0" upper="10000.0">
                </distr>
            </prior>

	          <!-- Parameter operators -->

	                   <operator
                       id='TTTSR0Scaler.t:$(n)'
                       spec='ScaleOperator'
                       scaleFactor=".9"
                       weight="1.0"
                       parameter="@TTTSR0.t:$(n)"/>

                     <operator
                       id="TTTSR0Walk.t:$(n)"
                       spec="RealRandomWalkOperator"
                       windowSize="0.01"
                       parameter="@TTTSR0.t:$(n)"
                       weight="1.0" />

	                   <operator
                       id='TTTSNetRemovalRateScaler.t:$(n)'
                       spec='ScaleOperator'
                       scaleFactor=".9"
                       weight="1.0"
                       parameter="@TTTSNetRemovalRate.t:$(n)"/>

                     <operator
                       id="TTTSNetRemovalRateWalk.t:$(n)"
                       spec="RealRandomWalkOperator"
                       windowSize="0.01"
                       parameter="@TTTSNetRemovalRate.t:$(n)"
                       weight="1.0" />

                     <operator
                       id="TTTSUpdownBS.t:$(n)"
                       spec="UpDownOperator"
                       scaleFactor="0.9"
                       weight="2.0">
                       <up idref="r0.t:$(n)" />
                       <down idref="TTTSNetRemovalRate.t:$(n)" />
                     </operator>

                     <operator
                       id="TTTSPropPsiScaler.t:$(n)"
                       spec="ScaleOperator"
                       scaleFactor="0.9"
                       parameter="@TTTSPropPsi.t:$(n)"
                       weight="1.0" />

                     <operator
                       id="TTTSPropPsiWalk.t:$(n)"
                       spec="RealRandomWalkOperator"
                       windowSize="0.01"
                       parameter="@TTTSPropPsi.t:$(n)"
                       weight="1.0" />

                     <operator
                       id="TTTSPropTimeSeriesScaler.t:$(n)"
                       spec="ScaleOperator"
                       scaleFactor="0.9"
                       parameter="@TTTSPropTS.t:$(n)"
                       weight="1.0" />

                     <operator
                       id="TTTSPropTimeSeriesWalk.t:$(n)"
                       spec="RealRandomWalkOperator"
                       windowSize="0.01"
                       parameter="@TTTSPropTS.t:$(n)"
                       weight="1.0" />

                     <operator
                       id="TTTSHistorySizesWalk.t:$(n)"
                       spec="IntRandomWalkOperator"
                       windowSize="20"
                       parameter="@TTTSHistorySizes.t:$(n)"
                       weight="3.0" />

                     <log
                       id="TimTamLogger.t:$(n)"
                       spec="timtam.TimTamLogger"
                       timtam="@TimTamTimeSeries.t:$(n)" />

            ]]>


            <connect srcID='TimTamTimeSeries.t:$(n)' targetID='prior' inputName='distribution' if='inposterior(TimTamTimeSeries.t:$(n)) and inlikelihood(Tree.t:$(n)) and Tree.t:$(n)/estimate=true' />
            <connect srcID='RandomTree.t:$(n)' targetID='mcmc' inputName='init' if='inposterior(Tree.t:$(n))' />

            <connect srcID='TTTSR0Prior.t:$(n)' targetID='prior' inputName='distribution' if='inposterior(TimTamTimeSeries.t:$(n)) and TTTSR0.t:$(n)/estimate=true and TimTamTimeSeries.t:$(n)/parameterisation=timeSeriesR0'>prior on R-naught</connect>
            <connect srcID='TTTSNetRemovalRatePrior.t:$(n)' targetID='prior' inputName='distribution' if='inposterior(TimTamTimeSeries.t:$(n)) and TTTSNetRemovalRate.t:$(n)/estimate=true and TimTamTimeSeries.t:$(n)/parameterisation=timeSeriesR0'>prior on the (approximate) net removal rate</connect>
            <connect srcID='TTTSPropPsiPrior.t:$(n)' targetID='prior' inputName='distribution' if='inposterior(TimTamTimeSeries.t:$(n)) and TTTSPropPsi.t:$(n)/estimate=true and TimTamTimeSeries.t:$(n)/parameterisation=timeSeriesR0'>prior on the proportion sequenced</connect>
            <connect srcID='TTTSPropTimeSeriesPrior.t:$(n)' targetID='prior' inputName='distribution' if='inposterior(TimTamTimeSeries.t:$(n)) and TTTSPropTS.t:$(n)/estimate=true and TimTamTimeSeries.t:$(n)/parameterisation=timeSeriesR0'>prior on the proportion in the time series</connect>
            <connect srcID='TTTSHistorySizesPrior.t:$(n)' targetID='prior' inputName='distribution' if='TTTSHistorySizes.t:$(n)/estimate=true'>BE VERY CAREFUL! the prevalence at the history times</connect>

            <connect srcID='TTTSR0Scaler.t:$(n)' targetID='mcmc' inputName='operator' if='inposterior(TimTamTimeSeries.t:$(n)) and TTTSR0.t:$(n)/estimate=true and TimTamTimeSeries.t:$(n)/parameterisation=timeSeriesR0'/>
            <connect srcID='TTTSR0Walk.t:$(n)' targetID='mcmc' inputName='operator' if='inposterior(TimTamTimeSeries.t:$(n)) and TTTSR0.t:$(n)/estimate=true and TimTamTimeSeries.t:$(n)/parameterisation=timeSeriesR0'/>
            <connect srcID='TTTSNetRemovalRateScaler.t:$(n)' targetID='mcmc' inputName='operator' if='inposterior(TimTamTimeSeries.t:$(n)) and TTTSNetRemovalRate.t:$(n)/estimate=true and TimTamTimeSeries.t:$(n)/parameterisation=timeSeriesR0'/>
            <connect srcID='TTTSNetRemovalRateWalk.t:$(n)' targetID='mcmc' inputName='operator' if='inposterior(TimTamTimeSeries.t:$(n)) and TTTSNetRemovalRate.t:$(n)/estimate=true and TimTamTimeSeries.t:$(n)/parameterisation=timeSeriesR0'/>
            <connect srcID='TTTSUpdownBS.t:$(n)' targetID='mcmc' inputName='operator' if='inposterior(TimTamTimeSeries.t:$(n)) and TTTSR0.t:$(n)/estimate=true and TTTSNetRemovalRate.t:$(n)/estimate=true and TimTamTimeSeries.t:$(n)/parameterisation=timeSeriesR0'/>
            <connect srcID='TTTSPropPsiScaler.t:$(n)' targetID='mcmc' inputName='operator' if='inposterior(TimTamTimeSeries.t:$(n)) and TTTSPropPsi.t:$(n)/estimate=true and TimTamTimeSeries.t:$(n)/parameterisation=timeSeriesR0'/>
            <connect srcID='TTTSPropPsiWalk.t:$(n)' targetID='mcmc' inputName='operator' if='inposterior(TimTamTimeSeries.t:$(n)) and TTTSPropPsi.t:$(n)/estimate=true and TimTamTimeSeries.t:$(n)/parameterisation=timeSeriesR0'/>
            <connect srcID='TTTSPropTimeSeriesScaler.t:$(n)' targetID='mcmc' inputName='operator' if='inposterior(TimTamTimeSeries.t:$(n)) and TTTSPropTS.t:$(n)/estimate=true and TimTamTimeSeries.t:$(n)/parameterisation=timeSeriesR0'/>
            <connect srcID='TTTSPropTimeSeriesWalk.t:$(n)' targetID='mcmc' inputName='operator' if='inposterior(TimTamTimeSeries.t:$(n)) and TTTSPropTS.t:$(n)/estimate=true and TimTamTimeSeries.t:$(n)/parameterisation=timeSeriesR0'/>
            <connect srcID='TTTSHistorySizesWalk.t:$(n)' targetID='mcmc' inputName='operator' if='TTTSHistorySizes.t:$(n)/estimate=true'/>

            <connect srcID='TimTamLogger.t:$(n)' targetID='tracelog' inputName='log' if='inposterior(TimTamTimeSeries.t:$(n))' />

            <!-- This connection is specified outside of the plate because otherwise it does not seem to work. -->
            <connect srcID='TTTSHistorySizes.t:$(n)' targetID='state' inputName='stateNode' if='TTTSHistorySizes.t:$(n)/estimate=true' />
            <connect srcID='TTTSHistorySizes.t:$(n)' targetID='tracelog' inputName='log' if='TTTSHistorySizes.t:$(n)/estimate=true' />

            <plate var='p' range='TTTSR0,TTTSNetRemovalRate,TTTSPropPsi,TTTSPropTS'>
                <connect srcID='$(p).t:$(n)' targetID='state' inputName='stateNode' if='inposterior(TimTamTimeSeries.t:$(n)) and $(p).t:$(n)/estimate=true' />
                <connect srcID='$(p).t:$(n)' targetID='tracelog' inputName='log' if='inposterior(TimTamTimeSeries.t:$(n)) and $(p).t:$(n)/estimate=true' />
            </plate>

			      <plate fragment="TreeOperators" var="m" range="TimTamTimeSeries"/>
        </subtemplate>
    </mergewith>

</beast>
